<div class="row">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h3 class="card-title mb-0">🎾 Predicción de Partido de Tenis</h3>
      </div>
      <div class="card-body">
        <p class="lead">Selecciona dos jugadores para predecir el ganador usando nuestro algoritmo de IA.</p>
        
        <%= form_with url: predict_predictions_path, method: :post, local: true, class: "needs-validation", novalidate: true do |form| %>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="player1_id" class="form-label">Jugador 1</label>
              <%= form.select :player1_id, 
                    options_from_collection_for_select(@players, :id, :name), 
                    { prompt: "Selecciona el primer jugador..." }, 
                    { class: "form-select", required: true } %>
              <div class="invalid-feedback">
                Por favor selecciona el primer jugador.
              </div>
            </div>
            
            <div class="col-md-6">
              <label for="player2_id" class="form-label">Jugador 2</label>
              <%= form.select :player2_id, 
                    options_from_collection_for_select(@players, :id, :name), 
                    { prompt: "Selecciona el segundo jugador..." }, 
                    { class: "form-select", required: true } %>
              <div class="invalid-feedback">
                Por favor selecciona el segundo jugador.
              </div>
            </div>
          </div>
          
          <div class="row mt-4">
            <div class="col-12">
              <%= form.submit "Predecir ganador del partido", class: "btn btn-success btn-lg w-100" %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    
    <% if @players.empty? %>
      <div class="alert alert-info mt-4" role="alert">
        <h5>No hay jugadores disponibles</h5>
        <p>Parece que no tenemos datos de jugadores aún. Haz clic abajo para cargar el ranking ATP.</p>
        <%= link_to "Cargar datos de jugadores", scrape_data_predictions_path, method: :post, class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
  
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header">
        <h5 class="card-title mb-0">Predicciones recientes</h5>
      </div>
      <div class="card-body">
        <% if @recent_predictions.any? %>
          <% @recent_predictions.each do |prediction| %>
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
              <div>
                <small class="text-muted d-block"><%= prediction.player1.name %> vs <%= prediction.player2.name %></small>
                <strong><%= prediction.predicted_winner.name %></strong>
                <span class="badge bg-secondary ms-1"><%= number_to_percentage(prediction.confidence * 100, precision: 1) %></span>
              </div>
              <small class="text-muted"><%= time_ago_in_words(prediction.prediction_date) %> atrás</small>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">Aún no hay predicciones. ¡Haz tu primera predicción!</p>
        <% end %>
      </div>
    </div>
    
    <div class="card shadow-sm mt-4">
      <div class="card-header">
        <h5 class="card-title mb-0">¿Cómo funciona?</h5>
      </div>
      <div class="card-body">
        <ul class="list-unstyled">
          <li class="mb-2">🏆 <strong>Ranking:</strong> Posición y puntos ATP actuales</li>
          <li class="mb-2">📊 <strong>Historial:</strong> Resultados de enfrentamientos previos</li>
          <li class="mb-2">📈 <strong>Forma reciente:</strong> Rendimiento en los últimos 10 partidos</li>
          <li class="mb-2">🤖 <strong>Algoritmo IA:</strong> Modelo de predicción con machine learning</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal for prediction result -->
<div class="modal fade" id="predictionModal" tabindex="-1" aria-labelledby="predictionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="predictionModalLabel">Resultado de la Predicción</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center" id="predictionModalBody">
        <!-- El resultado aparecerá aquí -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
// Bootstrap form validation
(function() {
  'use strict';
  window.addEventListener('load', function() {
    var forms = document.getElementsByClassName('needs-validation');
    var validation = Array.prototype.filter.call(forms, function(form) {
      form.addEventListener('submit', function(event) {
        if (form.checkValidity() === false) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });
  }, false);
})();

// Show modal with prediction result after form submit
function showPredictionModal(resultHtml) {
  document.getElementById('predictionModalBody').innerHTML = resultHtml;
  var modal = new bootstrap.Modal(document.getElementById('predictionModal'));
  modal.show();
}

// Intercept form submit to show modal
const form = document.querySelector('form');
if (form) {
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    fetch(form.action, {
      method: 'POST',
      body: new FormData(form),
      headers: { 'Accept': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      // Build result HTML in Spanish
      let html = `<h2>El jugador con más probabilidad de ganar es:</h2><h1 class='text-success'>${data.predicted_winner}</h1><h4>Confianza: <span class='badge bg-success'>${data.confidence}%</span></h4>`;
      showPredictionModal(html);
    });
  });
}
</script>
